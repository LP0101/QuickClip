<!doctype html>
<html>
<title>QuickClip</title>

<head>
    <link rel=stylesheet type=text/css href="{{ url_for('static', filename='style.css') }}">
    <link rel="shortcut icon" href="{{ url_for('static', filename='favicon.ico') }}">
</head>

<body>
    <div class="header">
        <h1><a class="link" href="/">QuickClip</a></h1>
    </div>
    <p>
        <ul class="alerts" id="alerts">
        </ul>
    </p>
        <div class="content">
            <form class="centered" id="uploadForm">
                <dl>
                    <p>
                        <input type="file" name="clip" id="inpFile">
                    </p>
                    {% if require_password %}
                        <label for="password" id="password-label" class="centered">Upload Password: </label><br id="password-br" class="centered" /><input type="text" name="password" id="password" class="centered"/>
                    {% endif %}
                </dl>
                <p>
                    <input class="button" type="submit" value="Upload"><br />
                </p>
            </form>
            <div class="centered">
                <input type="checkbox" id="clipboard" checked> <label for="clipboard">Send URL to Clipboard</label>
            </div>
            <div class="progress-bar" id="progressBar">
                <div class="progress-bar-fill">
                    <span class="progress-bar-text">0%</span>
                </div>
            </div>
        </div>
    </div>
    <script>
        const uploadForm = document.getElementById("uploadForm");
        const inpFile = document.getElementById("inpFile")
        const progressBarFill = document.querySelector("#progressBar > .progress-bar-fill");
        const progressBarText = progressBarFill.querySelector(".progress-bar-text");
        const sleep = ms => new Promise(res => setTimeout(res, ms));
        cookies = Object.fromEntries(document.cookie.split('; ').map(v=>v.split(/=(.*)/s).map(decodeURIComponent)))

        document.addEventListener("DOMContentLoaded", function () {
            if (!document.body.contains(document.getElementById('password'))) { 
                return
            }
            if(cookies.hasOwnProperty('password') && cookies.password != ""){
                document.getElementById("password").style.display = "none"
                document.getElementById("password").value = cookies.password
                document.getElementById("password-label").style.display = "none"
                document.getElementById("password-br").style.display = "none"
            } 
        })

        uploadForm.addEventListener("submit", uploadFile);

        function uploadFile (e) {
            e.preventDefault();


            const xhr = new XMLHttpRequest();

            xhr.open("POST", "/upload")
            xhr.upload.addEventListener("progress", e => {
                const percent = e.lengthComputable ? (e.loaded / e.total) * 100 : 0;

                progressBarFill.style.width = percent.toFixed(2) + "%";
                progressBarText.textContent = percent.toFixed(2) + "%";
            });

            xhr.send(new FormData(uploadForm));

            xhr.onload = async function() {
                data = JSON.parse(xhr.responseText);
                status = xhr.status;
                if (status == 401 && cookies.hasOwnProperty('password')) {
                    document.cookie = 'password=; expires = Thu, 01 Jan 1970 00:00:00 GMT'
                    let el = document.createElement("li"),
                        content = document.createTextNode("Please retry"),
                        alerts = document.getElementById("alerts")
                    el.appendChild(content)
                    alerts.appendChild(el)
                    document.getElementById("password").style.display = "block"
                    document.getElementById("password").value = ""
                    document.getElementById("password-label").style.display = "block"
                    document.getElementById("password-br").style.display = "block"
                }
                else if (status != 200 ) {
                    let el = document.createElement("li"),
                        content = document.createTextNode("Error uploading video"),
                        alerts = document.getElementById("alerts")
                    el.appendChild(content)
                    alerts.appendChild(el)
                }
                else {
                    if (document.body.contains(document.getElementById('password'))) {
                        console.log("ahhhh")
                        password = document.getElementById("password").value;
                        document.cookie = `password=${password}; expires = Fri, 31 Dec 9999 23:59:59 GMT; SameSite=Strict`;
                    }
                    video = data.clip
                    shareable_link = window.location.origin+"/v/"+video
                    await sleep(500) // Video is broken if the page is instantly loaded
                    if (document.querySelector('#clipboard').checked) {
                        navigator.clipboard.writeText(shareable_link);
                    }
                    document.location.href = shareable_link;
                }
            }
        }
    </script>
</body>

</html>